<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name="hugo-theme" content="Axiom 0.7.2">



  <link rel="icon" type="image/png" sizes="32x32" href="https://julhe.github.io/">
  <link rel="icon" type="image/x-icon" href="https://julhe.github.io/">
  <link rel="apple-touch-icon" href="https://julhe.github.io/">
  <link rel="canonical" href="https://julhe.github.io/posts/basic_voronoi_in_unity_and_burst/">
<link rel="preload" as="style" href="https://julhe.github.io/bundle.css?v=1640886549" media="all">
<link rel="stylesheet" href="https://julhe.github.io/bundle.css?v=1640886549" media="all">
<style>.cdata pre{color:#edf2f7;background-color:#2d3748}.cdata :not(pre)>code{color:#805ad5;background-color:#f7fafc}.chroma .err{color:#fed7d7;background-color:#9b2c2c}.chroma .hl{background-color:#4a5568}.chroma .ln{color:#a0aec0}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#63b3ed}.chroma .kt{color:#b794f4}.chroma .na{color:#f6e05e}.chroma .nb{color:#f6ad55}.chroma .nc{color:#fc8181}.chroma .no{color:#68d391}.chroma .nd{color:#fc8181}.chroma .ne{color:#fc8181}.chroma .nf{color:#f6ad55}.chroma .nt{color:#fc8181}.chroma .l{color:#b794f4}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#68d391}.chroma .se{color:#a0aec0}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#68d391}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#b794f4}.chroma .o,.chroma .ow{color:#90cdf4}.chroma .p{color:#cbd5e0}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs{color:#a0aec0}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}
</style>



<title>Basic Voronoi with Unity and Burst : julhe.github.io</title>

<meta property="og:title" content="Basic Voronoi with Unity and Burst">
<meta property="og:site_name" content="julhe.github.io">
<meta property="og:url" content="https://julhe.github.io/posts/basic_voronoi_in_unity_and_burst/">
<link rel="image_src" href="https://julhe.github.io/">
<meta property="og:image" content="https://julhe.github.io/">
<meta property="og:image:width" content="">
<meta property="og:image:height" content="">
<meta property="og:type" content="article">
<meta property="og:locale" content="en_us">
<meta property="og:description" content="I recently showed some Voronoi experiments stuff on twitter, so here is a write up off what’s happening here.">
<meta name="description" content="I recently showed some Voronoi experiments stuff on twitter, so here is a write up off what’s happening here.">
<meta property="og:updated_time" content="2019-10-10T00:00:00Z">
<meta property="fb:app_id" content="">
<meta name="author" content="Unknown">
<meta property="article:author" content="https://julhe.github.io/">
<meta property="article:published_time" content="2019-10-10T00:00:00Z">
<meta property="article:modified_time" content="2019-10-10T00:00:00Z">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Basic Voronoi with Unity and Burst",
  "alternativeHeadline": "I recently showed some Voronoi experiments stuff on twitter, so here is a write up off what’s happening here.",
  "url": "https://julhe.github.io/posts/basic_voronoi_in_unity_and_burst/",
  "image": "https://julhe.github.io/",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://julhe.github.io/posts/basic_voronoi_in_unity_and_burst/"
  },
  "description": "I recently showed some Voronoi experiments stuff on twitter, so here is a write up off what’s happening here.",
  "author": {
    "@type": "Person",
    "name": "Unknown"
  },
  "publisher": {
    "@type": "Organization",
    "name": "julhe.github.io",
    "logo": {
      "@type": "ImageObject",
      "url": "https://julhe.github.io/"
    }
  },
  "datePublished": "2019-10-10T00:00:00Z",
  "dateModified": "2019-10-10T00:00:00Z",
  "articleBody": "\u003cp\u003eI recently showed some Voronoi experiments stuff on twitter, so here is a write up off what’s happening here\u003c/p\u003e\n\u003ccenter\u003e\r\n\u003cblockquote class=\"twitter-tweet\" data-dnt=\"true\" data-theme=\"dark\"\u003e\u003cp lang=\"it\" dir=\"ltr\"\u003ebasic voronoi in unity ECS✅ \u003ca href=\"https://t.co/TIsxNuCJcG\"\u003epic.twitter.com/TIsxNuCJcG\u003c/a\u003e\u003c/p\u003e\u0026mdash; Julian (@schneckerstein) \u003ca href=\"https://twitter.com/schneckerstein/status/1181905921796136960?ref_src=twsrc%5Etfw\"\u003eOctober 9, 2019\u003c/a\u003e\u003c/blockquote\u003e \u003cscript async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"\u003e\u003c/script\u003e \r\n\u003c/center\u003e\r\n\u003chr\u003e\n\u003ch1 id=\"voronoi-101\"\u003eVoronoi 101\u003c/h1\u003e\n\u003cp\u003eA voronoi diagram describes the partition of space by a set of seeds. Each seed expands it\u0026rsquo;s boundaries, until it reaches the boundary of another seed.\u003c/p\u003e\n\r\n\r\n\u003cfigure\u003e\r\n\u003cimg\r\nclass=\"mb-2 mx-auto leading-none shadow-xl\"\r\nsrc=\"/posts/basic_voronoi_in_unity_and_burst/voronoi_grow.gif\"\u003e\r\n\u003c/figure\u003e\r\n\n\u003cp\u003eThere are many ways to compute a Voronoi diagram. Usually you can get an exact geometric result with \u003ca href=\"https://jacquesh.github.io/post/fortunes-algorithm/\"\u003eFortunes algorithm\u003c/a\u003e or by \u003ca href=\"https://pages.mtu.edu/~shene/PUBLICATIONS/2004/Hull2VD.pdf\"\u003eexploiting the hidden links between the convex hull, the Delaunay-Triangulation and the Voronoi diagramm\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eBut I will use a simple 64x64 grid, further called Voronoi map. This will not lead to an actual precise geometric representation, but something that is (hopefully) understandable and easier to modify.\u003c/p\u003e\n\u003cp\u003eBefore we go into detail, a little primer on Burst and Jobs.\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"burst-and-job-system\"\u003eBurst and Job-System\u003c/h1\u003e\n\u003cp\u003eFor our Voronoi map, we are going to iterate over every pixel. Most straightforward is a for loop:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-csharp\" data-lang=\"csharp\"\u003e\u003cspan style=\"color:#ff79c6\"\u003efor\u003c/span\u003e(\u003cspan style=\"color:#8be9fd\"\u003eint\u003c/span\u003e i = \u003cspan style=\"color:#bd93f9\"\u003e0\u003c/span\u003e; i \u0026lt; vornoiMap.Length; i++){\n    \u003cspan style=\"color:#6272a4\"\u003e// compute Voronoi\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBut we are dealing with lots of pixels here. Even at a resolution of 64x64, this means 4096 pixels, multiplied by the number of sites. Therefore, are going to use Burst and Jobs. The Unity Job system allows us to split our for-loop across multiple threads.\u003c/p\u003e\n\u003cp\u003eIn pseudocode:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-csharp\" data-lang=\"csharp\"\u003e\u003cspan style=\"color:#ff79c6\"\u003efor\u003c/span\u003e batch \u003cspan style=\"color:#ff79c6\"\u003ein\u003c/span\u003e allBatches\n    \u003cspan style=\"color:#ff79c6\"\u003enew\u003c/span\u003e Thread() {\n        \u003cspan style=\"color:#ff79c6\"\u003efor\u003c/span\u003e(\u003cspan style=\"color:#8be9fd\"\u003eint\u003c/span\u003e i = \u003cspan style=\"color:#bd93f9\"\u003e0\u003c/span\u003e; i \u0026lt; batch.Length; i++){\n            \u003cspan style=\"color:#6272a4\"\u003e// compute voronoi\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e        }\n    }\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOn a machine with 4 CPU-Cores, this can mean a performance improvement of up to 4x.\u003c/p\u003e\n\u003cp\u003eThe second thing we are going to use is the Burst Compiler. Very roughly speaking, it optimizes the bytecode generated by the C# compiler even further by utilizing special CPU instructions and deeper analysis of the code.\u003c/p\u003e\n\u003cp\u003eBurst however is not applied onto our whole code. Instead, it is meant to be applied on single Jobs. A further requirement is the absence of any managed variables. In practice, that means we can only use structs and basic variable types such as float or int.\u003c/p\u003e\n\u003cp\u003eHere is an (incomplete) table for the correct equivalent:\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eClassic Unity\u003c/th\u003e\n\u003cth\u003eBurst Compatible\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eVector2/3/4\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003efloat2/3/4\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eVectorInt2/3/4\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003eint2/3/4\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003efoo[]\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003eNativeArray\u0026lt;foo\u0026gt;\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eList\u0026lt;foo\u0026gt;\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003eNativeList\u0026lt;foo\u0026gt;\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eVector2/3/4.Distance()\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003emath.distance()\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eMathf.Sin()\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003emath.sin()\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eAlso, we must manage some memory on our own. This means that we have to call \u003ccode\u003e.Dispose()\u003c/code\u003e on \u003ccode\u003eNativeArray/List\u0026lt;\u0026gt;\u003c/code\u003e struct once we don\u0026rsquo;t need it anymore.\u003c/p\u003e\n\u003ch1 id=\"the-algorithm\"\u003eThe Algorithm\u003c/h1\u003e\n\u003cp\u003eLet\u0026rsquo;s jump back into Voronoi land and code the job that generates the Voronoi Map. For this section I will let the code comments speak, as I\u0026rsquo;ve already explained the basic idea of the Voronoi diagram. Also note here that I explicitly tell Unity if a variable is read/write only, which makes the purpose clearer for both the compiler and any potential reader. 😉\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\n\u003ctable style=\"border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;\"\u003e\u003ctr\u003e\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;\"\u003e\n\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 1\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 2\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 3\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 4\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 5\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 6\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 7\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 8\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e 9\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e10\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e11\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e12\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e13\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e14\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e15\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e16\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e17\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e18\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e19\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e20\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e21\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e22\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e23\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e24\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e25\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e26\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e27\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e28\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e29\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e30\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e31\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e32\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e33\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e34\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e35\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e36\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e37\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e38\n\u003c/span\u003e\u003cspan style=\"margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f\"\u003e39\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd style=\"vertical-align:top;padding:0;margin:0;border:0;;width:100%\"\u003e\n\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-csharp\" data-lang=\"csharp\"\u003e\u003cspan style=\"color:#50fa7b\"\u003e\n\u003c/span\u003e\u003cspan style=\"color:#50fa7b\"\u003e[BurstCompile]\u003c/span\u003e\n\u003cspan style=\"color:#ff79c6\"\u003estruct\u003c/span\u003e \u003cspan style=\"color:#50fa7b\"\u003eRenderVoronoi\u003c/span\u003e : IJobParallelFor{\n    \u003cspan style=\"color:#6272a4\"\u003e// the data that we are going to use\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e\u003cspan style=\"color:#50fa7b\"\u003e    [ReadOnly]\u003c/span\u003e \u003cspan style=\"color:#ff79c6\"\u003epublic\u003c/span\u003e int2 resolution; \u003cspan style=\"color:#6272a4\"\u003e// the resolution in cells/pixels\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e\u003cspan style=\"color:#50fa7b\"\u003e    [ReadOnly]\u003c/span\u003e \u003cspan style=\"color:#ff79c6\"\u003epublic\u003c/span\u003e float2 cellsMinWs, cellsMaxWs; \u003cspan style=\"color:#6272a4\"\u003e// world space boundaries\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e\u003cspan style=\"color:#50fa7b\"\u003e    [ReadOnly]\u003c/span\u003e \u003cspan style=\"color:#ff79c6\"\u003epublic\u003c/span\u003e NativeArray\u0026lt;float3\u0026gt; sites; \u003cspan style=\"color:#6272a4\"\u003e// list of the position of all sites\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e\u003cspan style=\"color:#50fa7b\"\u003e    [ReadOnly]\u003c/span\u003e \u003cspan style=\"color:#ff79c6\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#8be9fd\"\u003efloat\u003c/span\u003e ExpandLimit; \u003cspan style=\"color:#6272a4\"\u003e//limits the expansion of sites, good for visualizations\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#6272a4\"\u003e// the data that we are going to put out\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e\u003cspan style=\"color:#50fa7b\"\u003e    [WriteOnly]\u003c/span\u003e \u003cspan style=\"color:#ff79c6\"\u003epublic\u003c/span\u003e NativeArray\u0026lt;\u003cspan style=\"color:#8be9fd\"\u003eint\u003c/span\u003e\u0026gt; VoronoiMap; \u003cspan style=\"color:#6272a4\"\u003e// output position map\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#6272a4\"\u003e// how we are going to compute the data\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#ff79c6\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#ff79c6\"\u003evoid\u003c/span\u003e Execute(\u003cspan style=\"color:#8be9fd\"\u003eint\u003c/span\u003e pixelIndex){\n        \u003cspan style=\"color:#6272a4\"\u003e// figure out the location of the cell in world space\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e        float2 pixelPositionWs;\n        \u003cspan style=\"color:#6272a4\"\u003e// first, we turn the pixelIndex into a 2D space coordinate...\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e        pixelPositionWs.x = pixelIndex % resolution.x;\n        pixelPositionWs.y = pixelIndex / resolution.x;\n        \u003cspan style=\"color:#6272a4\"\u003e//note: it would be actually faster to stay in pixel coordinates from here on and convert the sites into pixel coordinates\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e        \u003cspan style=\"color:#6272a4\"\u003e// ...now normalized position into a range [0,1], so that 0 = cellsMinWs and 1 = cellsMaxWs...\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e        pixelPositionWs.x /= resolution.x; \n        pixelPositionWs.y /= resolution.y;\n        \u003cspan style=\"color:#6272a4\"\u003e// ...and transform into world space\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e        pixelPositionWs = math.lerp(cellsMinWs, cellsMaxWs, pixelPositionWs);\n\n        \u003cspan style=\"color:#6272a4\"\u003e// keep track of the shortest distance\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e        \u003cspan style=\"color:#8be9fd\"\u003efloat\u003c/span\u003e closestSiteDistance = ExpandLimit; \u003cspan style=\"color:#6272a4\"\u003e// if you don\u0026#39;t want to limit, use float.PositiveInfinty\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e        \u003cspan style=\"color:#8be9fd\"\u003eint\u003c/span\u003e closestSiteId = -\u003cspan style=\"color:#bd93f9\"\u003e1\u003c/span\u003e;\n        \u003cspan style=\"color:#ff79c6\"\u003efor\u003c/span\u003e (\u003cspan style=\"color:#8be9fd\"\u003eint\u003c/span\u003e siteId = \u003cspan style=\"color:#bd93f9\"\u003e0\u003c/span\u003e; siteId \u0026lt; sites.Length; siteId++){\n            float2 sitePosition = sites[siteId].xy; \n            \u003cspan style=\"color:#8be9fd\"\u003efloat\u003c/span\u003e siteDistance = math.distance(sitePosition, pixelPositionWs); \u003cspan style=\"color:#6272a4\"\u003e// compute the distance between cell and site\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e            \u003cspan style=\"color:#ff79c6\"\u003eif\u003c/span\u003e (siteDistance \u0026lt; closestSiteDistance) {\n                \u003cspan style=\"color:#6272a4\"\u003e// if the curret site is closer than the previous one, remember it\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e                closestSiteDistance = siteDistance; \n                closestSiteId = siteId;\n            }\n        }\n        VoronoiMap[pixelIndex] = closestSiteId; \u003cspan style=\"color:#6272a4\"\u003e// write the result back\n\u003c/span\u003e\u003cspan style=\"color:#6272a4\"\u003e\u003c/span\u003e    }\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eYou can find the entire implementation in the gist at the very end of this post (version without noise).\u003c/p\u003e\n\u003ch1 id=\"bring-in-the-noise\"\u003eBring in the Noise\u003c/h1\u003e\n\u003cp\u003eIn the second tweet, I added noise to make the whole thing more interesting.\u003c/p\u003e\n\u003ccenter\u003e\r\n\u003cblockquote class=\"twitter-tweet\" data-conversation=\"none\" data-dnt=\"true\" data-theme=\"dark\"\u003e\u003cp lang=\"en\" dir=\"ltr\"\u003enoise makes everything better™️ \u003ca href=\"https://t.co/IXV8FYozmk\"\u003epic.twitter.com/IXV8FYozmk\u003c/a\u003e\u003c/p\u003e\u0026mdash; Julian (@schneckerstein) \u003ca href=\"https://twitter.com/schneckerstein/status/1181924753776500737?ref_src=twsrc%5Etfw\"\u003eOctober 9, 2019\u003c/a\u003e\u003c/blockquote\u003e \u003cscript async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"\u003e\u003c/script\u003e \r\n\u003c/center\u003e\r\nThis is really simple to achieve, at least for our pixel Voronoi approach. The [Unity Mathematics Library](https://docs.unity3d.com/Packages/com.unity.mathematics@1.1/manual/index.html) also has built in procedural noise functions, which also makes the implementation straightforward. Unfortunately, the library is poorly documented, so I don't know what exact function ```snoise()``` implements, but it looks good enough...\r\n\u003cp\u003eAnyway, Noise in our case is applied like this (inside the RenderVoronoi Job):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-csharp\" data-lang=\"csharp\"\u003e\u003cspan style=\"color:#8be9fd\"\u003efloat\u003c/span\u003e noise = math.abs(Unity.Mathematics.noise.snoise((sitePosition + pixelPositionWs) * NoiseTiling));\nnoise *= NoiseScale;\nsiteDistance += noise;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNote that I use the sum of  \u003ccode\u003esitePosition\u003c/code\u003e and  \u003ccode\u003epixelPositionWs\u003c/code\u003e. This is important, because if we just use the pixel position, the noise would be the same for all site and therefore would have no effect.\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"source-code\"\u003eSource Code\u003c/h1\u003e\n\u003cscript src=\"https://gist.github.com/julhe/1223091d27782e7f0ec38ceb065ab7ac.js\"\u003e\u003c/script\u003e"
}
</script>

<link rel="preload" as="script" href="https://julhe.github.io/bundle.js?v=1640886549">


</head>
<body>

  <header id="nav" class="header">
  <div class="ax-l-i max-w-6xl">
    <div class="ax-logo">
      <a class="block" href="https://julhe.github.io/" title="julhe.github.io"><span class="font-semibold text-raven-900">julhe.github.io</span></a>
    </div>
    <div class="ax-user">
      <a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target="_blank" rel="noopener nofollow" href="https://www.google.com/search?q=site:https://julhe.github.io/" title="Search">
        <svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923l-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33 0 0 0 2.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg>

      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="https://julhe.github.io/about">
        About
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="https://julhe.github.io/posts">
        Posts
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="https://julhe.github.io/showcase">
        Showcase
      </a>
    </div>
  </div>

  
</header>

  <main>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<div class="default-single">
  <div class="ax-title ax-l-o">
    <div class="ax-l-i max-w-680">
      <h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">Basic Voronoi with Unity and Burst</h1>

      <div class="ax-meta flex items-center mt-5">
        <div class="flex-grow min-w-0">
          <div class="flex items-center">
  <div class="flex-shrink-0">
    
  </div>
  <div class="flex-shrink-0 ml-2 leading-tight font-content-sans">
    <a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target="_blank" rel="noopener nofollow" title="Unknown" href="https://julhe.github.io/">Unknown</a>
    <time class="text-sm text-raven-500" datetime="2019-10-10T00:00:00Z">Oct 10, 2019 2:00AM</time>
  </div>
</div>

        </div>
        <div>
          <div class="flex items-center">
  <a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=Basic%20Voronoi%20with%20Unity%20and%20Burst%20by%20%40%23%20https%3a%2f%2fjulhe.github.io%2fposts%2fbasic_voronoi_in_unity_and_burst%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg>
</a>
  <a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2fjulhe.github.io%2fposts%2fbasic_voronoi_in_unity_and_burst%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234 0H1.765C.8.001 0 .79 0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766 0 3.284.13 3.726.2v4.32h-2.543c-2.006 0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21 0 30.234 0z"/></svg>
</a>
</div>

        </div>
      </div>
    </div>
  </div><div class="ax-content ax-l-o">
    <div class="ax-l-i max-w-680">
      <article class="cdata">
<p>I recently showed some Voronoi experiments stuff on twitter, so here is a write up off what’s happening here</p>
<center>
<blockquote class="twitter-tweet" data-dnt="true" data-theme="dark"><p lang="it" dir="ltr">basic voronoi in unity ECS✅ <a href="https://t.co/TIsxNuCJcG">pic.twitter.com/TIsxNuCJcG</a></p>&mdash; Julian (@schneckerstein) <a href="https://twitter.com/schneckerstein/status/1181905921796136960?ref_src=twsrc%5Etfw">October 9, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
</center>
<hr>
<h1 id="voronoi-101">Voronoi 101</h1>
<p>A voronoi diagram describes the partition of space by a set of seeds. Each seed expands it&rsquo;s boundaries, until it reaches the boundary of another seed.</p>


<figure>
<img
class="mb-2 mx-auto leading-none shadow-xl"
src="https://julhe.github.io/posts/basic_voronoi_in_unity_and_burst/voronoi_grow.gif">
</figure>

<p>There are many ways to compute a Voronoi diagram. Usually you can get an exact geometric result with <a href="https://jacquesh.github.io/post/fortunes-algorithm/">Fortunes algorithm</a> or by <a href="https://pages.mtu.edu/~shene/PUBLICATIONS/2004/Hull2VD.pdf">exploiting the hidden links between the convex hull, the Delaunay-Triangulation and the Voronoi diagramm</a>.</p>
<p>But I will use a simple 64x64 grid, further called Voronoi map. This will not lead to an actual precise geometric representation, but something that is (hopefully) understandable and easier to modify.</p>
<p>Before we go into detail, a little primer on Burst and Jobs.</p>
<hr>
<h1 id="burst-and-job-system">Burst and Job-System</h1>
<p>For our Voronoi map, we are going to iterate over every pixel. Most straightforward is a for loop:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#ff79c6">for</span>(<span style="color:#8be9fd">int</span> i = <span style="color:#bd93f9">0</span>; i &lt; vornoiMap.Length; i++){
    <span style="color:#6272a4">// compute Voronoi
</span><span style="color:#6272a4"></span>}
</code></pre></div><p>But we are dealing with lots of pixels here. Even at a resolution of 64x64, this means 4096 pixels, multiplied by the number of sites. Therefore, are going to use Burst and Jobs. The Unity Job system allows us to split our for-loop across multiple threads.</p>
<p>In pseudocode:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#ff79c6">for</span> batch <span style="color:#ff79c6">in</span> allBatches
    <span style="color:#ff79c6">new</span> Thread() {
        <span style="color:#ff79c6">for</span>(<span style="color:#8be9fd">int</span> i = <span style="color:#bd93f9">0</span>; i &lt; batch.Length; i++){
            <span style="color:#6272a4">// compute voronoi
</span><span style="color:#6272a4"></span>        }
    }

</code></pre></div><p>On a machine with 4 CPU-Cores, this can mean a performance improvement of up to 4x.</p>
<p>The second thing we are going to use is the Burst Compiler. Very roughly speaking, it optimizes the bytecode generated by the C# compiler even further by utilizing special CPU instructions and deeper analysis of the code.</p>
<p>Burst however is not applied onto our whole code. Instead, it is meant to be applied on single Jobs. A further requirement is the absence of any managed variables. In practice, that means we can only use structs and basic variable types such as float or int.</p>
<p>Here is an (incomplete) table for the correct equivalent:</p>
<table>
<thead>
<tr>
<th>Classic Unity</th>
<th>Burst Compatible</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Vector2/3/4</code></td>
<td><code>float2/3/4</code></td>
</tr>
<tr>
<td><code>VectorInt2/3/4</code></td>
<td><code>int2/3/4</code></td>
</tr>
<tr>
<td><code>foo[]</code></td>
<td><code>NativeArray&lt;foo&gt;</code></td>
</tr>
<tr>
<td><code>List&lt;foo&gt;</code></td>
<td><code>NativeList&lt;foo&gt;</code></td>
</tr>
<tr>
<td><code>Vector2/3/4.Distance()</code></td>
<td><code>math.distance()</code></td>
</tr>
<tr>
<td><code>Mathf.Sin()</code></td>
<td><code>math.sin()</code></td>
</tr>
</tbody>
</table>
<p>Also, we must manage some memory on our own. This means that we have to call <code>.Dispose()</code> on <code>NativeArray/List&lt;&gt;</code> struct once we don&rsquo;t need it anymore.</p>
<h1 id="the-algorithm">The Algorithm</h1>
<p>Let&rsquo;s jump back into Voronoi land and code the job that generates the Voronoi Map. For this section I will let the code comments speak, as I&rsquo;ve already explained the basic idea of the Voronoi diagram. Also note here that I explicitly tell Unity if a variable is read/write only, which makes the purpose clearer for both the compiler and any potential reader. 😉</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#50fa7b">
</span><span style="color:#50fa7b">[BurstCompile]</span>
<span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">RenderVoronoi</span> : IJobParallelFor{
    <span style="color:#6272a4">// the data that we are going to use
</span><span style="color:#6272a4"></span><span style="color:#50fa7b">    [ReadOnly]</span> <span style="color:#ff79c6">public</span> int2 resolution; <span style="color:#6272a4">// the resolution in cells/pixels
</span><span style="color:#6272a4"></span><span style="color:#50fa7b">    [ReadOnly]</span> <span style="color:#ff79c6">public</span> float2 cellsMinWs, cellsMaxWs; <span style="color:#6272a4">// world space boundaries
</span><span style="color:#6272a4"></span><span style="color:#50fa7b">    [ReadOnly]</span> <span style="color:#ff79c6">public</span> NativeArray&lt;float3&gt; sites; <span style="color:#6272a4">// list of the position of all sites
</span><span style="color:#6272a4"></span><span style="color:#50fa7b">    [ReadOnly]</span> <span style="color:#ff79c6">public</span> <span style="color:#8be9fd">float</span> ExpandLimit; <span style="color:#6272a4">//limits the expansion of sites, good for visualizations
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// the data that we are going to put out
</span><span style="color:#6272a4"></span><span style="color:#50fa7b">    [WriteOnly]</span> <span style="color:#ff79c6">public</span> NativeArray&lt;<span style="color:#8be9fd">int</span>&gt; VoronoiMap; <span style="color:#6272a4">// output position map
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// how we are going to compute the data
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">public</span> <span style="color:#ff79c6">void</span> Execute(<span style="color:#8be9fd">int</span> pixelIndex){
        <span style="color:#6272a4">// figure out the location of the cell in world space
</span><span style="color:#6272a4"></span>        float2 pixelPositionWs;
        <span style="color:#6272a4">// first, we turn the pixelIndex into a 2D space coordinate...
</span><span style="color:#6272a4"></span>        pixelPositionWs.x = pixelIndex % resolution.x;
        pixelPositionWs.y = pixelIndex / resolution.x;
        <span style="color:#6272a4">//note: it would be actually faster to stay in pixel coordinates from here on and convert the sites into pixel coordinates
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// ...now normalized position into a range [0,1], so that 0 = cellsMinWs and 1 = cellsMaxWs...
</span><span style="color:#6272a4"></span>        pixelPositionWs.x /= resolution.x; 
        pixelPositionWs.y /= resolution.y;
        <span style="color:#6272a4">// ...and transform into world space
</span><span style="color:#6272a4"></span>        pixelPositionWs = math.lerp(cellsMinWs, cellsMaxWs, pixelPositionWs);

        <span style="color:#6272a4">// keep track of the shortest distance
</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd">float</span> closestSiteDistance = ExpandLimit; <span style="color:#6272a4">// if you don&#39;t want to limit, use float.PositiveInfinty
</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd">int</span> closestSiteId = -<span style="color:#bd93f9">1</span>;
        <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> siteId = <span style="color:#bd93f9">0</span>; siteId &lt; sites.Length; siteId++){
            float2 sitePosition = sites[siteId].xy; 
            <span style="color:#8be9fd">float</span> siteDistance = math.distance(sitePosition, pixelPositionWs); <span style="color:#6272a4">// compute the distance between cell and site
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> (siteDistance &lt; closestSiteDistance) {
                <span style="color:#6272a4">// if the curret site is closer than the previous one, remember it
</span><span style="color:#6272a4"></span>                closestSiteDistance = siteDistance; 
                closestSiteId = siteId;
            }
        }
        VoronoiMap[pixelIndex] = closestSiteId; <span style="color:#6272a4">// write the result back
</span><span style="color:#6272a4"></span>    }
}
</code></pre></td></tr></table>
</div>
</div><p>You can find the entire implementation in the gist at the very end of this post (version without noise).</p>
<h1 id="bring-in-the-noise">Bring in the Noise</h1>
<p>In the second tweet, I added noise to make the whole thing more interesting.</p>
<center>
<blockquote class="twitter-tweet" data-conversation="none" data-dnt="true" data-theme="dark"><p lang="en" dir="ltr">noise makes everything better™️ <a href="https://t.co/IXV8FYozmk">pic.twitter.com/IXV8FYozmk</a></p>&mdash; Julian (@schneckerstein) <a href="https://twitter.com/schneckerstein/status/1181924753776500737?ref_src=twsrc%5Etfw">October 9, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
</center>
This is really simple to achieve, at least for our pixel Voronoi approach. The [Unity Mathematics Library](https://docs.unity3d.com/Packages/com.unity.mathematics@1.1/manual/index.html) also has built in procedural noise functions, which also makes the implementation straightforward. Unfortunately, the library is poorly documented, so I don't know what exact function ```snoise()``` implements, but it looks good enough...
<p>Anyway, Noise in our case is applied like this (inside the RenderVoronoi Job):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#8be9fd">float</span> noise = math.abs(Unity.Mathematics.noise.snoise((sitePosition + pixelPositionWs) * NoiseTiling));
noise *= NoiseScale;
siteDistance += noise;
</code></pre></div><p>Note that I use the sum of  <code>sitePosition</code> and  <code>pixelPositionWs</code>. This is important, because if we just use the pixel position, the noise would be the same for all site and therefore would have no effect.</p>
<hr>
<h1 id="source-code">Source Code</h1>
<script src="https://gist.github.com/julhe/1223091d27782e7f0ec38ceb065ab7ac.js"></script>
      </article>
      

      

    </div>
  </div>
</div>
<hr>
<script src="https://utteranc.es/client.js"
        repo="julhe/julhe.github.io"
        issue-term="pathname"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

  </main>
  <footer class="footer">
  <div class="ax-l-i max-w-6xl">
    <nav class="flex items-center justify-center">
    </nav>
    <div class="footer-social flex items-center justify-center mt-4">
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Twitter" href="https://twitter.com/schneckerstein"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Github" href="https://github.com/julhe"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998 0C7.164 0 0 7.35 0 16.417 0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113 0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344 0 0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98 0 0 1 4.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406 0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836 0 15.998 0z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="LinkedIn" href="https://www.linkedin.com/in/julian-heinken-34463327/"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M29.692 0H2.308A2.31 2.31 0 0 0 0 2.308v27.384A2.31 2.31 0 0 0 2.308 32h27.384A2.31 2.31 0 0 0 32 29.692V2.308A2.31 2.31 0 0 0 29.692 0zM11.35 24.188H7.454V12.464h3.897v11.723zM9.402 10.863h-.025c-1.308 0-2.153-.9-2.153-2.025 0-1.15.872-2.026 2.205-2.026s2.153.875 2.18 2.026c0 1.125-.846 2.025-2.205 2.025zm16 13.324h-3.896v-6.272c0-1.576-.564-2.65-1.974-2.65-1.076 0-1.717.725-2 1.425-.103.25-.128.6-.128.95v6.547h-3.896V12.464h3.896v1.66c.518-.8 1.444-1.935 3.512-1.935 2.564 0 4.486 1.676 4.486 5.276v6.722z"/></svg></a>
    </div>

    <div class="footer-copyright text-sm text-center text-gray-500 mt-4">
      &#169; -2021 Julian Heinken
    </div>
    <div class="text-sm sm:text-xs text-center text-gray-500 mt-2">
      Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a>
    </div>
  </div>
</footer>

<script src="https://julhe.github.io/bundle.js?v=1640886549"></script>


</body>
</html>
