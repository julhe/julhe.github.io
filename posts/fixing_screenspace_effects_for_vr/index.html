<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name="hugo-theme" content="Axiom 0.7.2">



  <link rel="icon" type="image/png" sizes="32x32" href="https://julhe.github.io/">
  <link rel="icon" type="image/x-icon" href="https://julhe.github.io/">
  <link rel="apple-touch-icon" href="https://julhe.github.io/">
  <link rel="canonical" href="https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/">
<link rel="preload" as="style" href="https://julhe.github.io/bundle.css?v=1711549188" media="all">
<link rel="stylesheet" href="https://julhe.github.io/bundle.css?v=1711549188" media="all">
<style>
  /* <code>:wrap */

.cdata pre {

    --tw-bg-opacity: 1;

    background-color: rgb(31 41 55 / var(--tw-bg-opacity))
}

.cdata pre {

    --tw-text-opacity: 1;

    color: rgb(229 231 235 / var(--tw-text-opacity))
}

/* <code>:inline */

.cdata :not(pre) > code {

    --tw-bg-opacity: 1;

    background-color: rgb(243 244 246 / var(--tw-bg-opacity))
}

.cdata :not(pre) > code {

    --tw-text-opacity: 1;

    color: rgb(147 51 234 / var(--tw-text-opacity))
}

/* Background */

.chroma {}

/* Other */

.chroma .x {}

/* Error */

.chroma .err {

    --tw-bg-opacity: 1;

    background-color: rgb(153 27 27 / var(--tw-bg-opacity));

    --tw-text-opacity: 1;

    color: rgb(254 202 202 / var(--tw-text-opacity))
}

/* LineTableTD */

.chroma .lntd {}

/* LineTable */

.chroma .lntable {}

/* LineHighlight */

.chroma .hl {

    --tw-bg-opacity: 1;

    background-color: rgb(55 65 81 / var(--tw-bg-opacity))
}

/* LineNumbersTable */

.chroma .lnt {}

/* LineNumbersTable */

.chroma .lnt {}

/* LineNumbers */

.chroma .ln {

    --tw-text-opacity: 1;

    color: rgb(107 114 128 / var(--tw-text-opacity))
}

/* Keyword */

.chroma .k {

    --tw-text-opacity: 1;

    color: rgb(96 165 250 / var(--tw-text-opacity))
}

/* KeywordConstant */

.chroma .kc {

    --tw-text-opacity: 1;

    color: rgb(96 165 250 / var(--tw-text-opacity))
}

/* KeywordDeclaration */

.chroma .kd {

    --tw-text-opacity: 1;

    color: rgb(96 165 250 / var(--tw-text-opacity))
}

/* KeywordNamespace */

.chroma .kn {

    --tw-text-opacity: 1;

    color: rgb(96 165 250 / var(--tw-text-opacity))
}

/* KeywordPseudo */

.chroma .kp {

    --tw-text-opacity: 1;

    color: rgb(96 165 250 / var(--tw-text-opacity))
}

/* KeywordReserved */

.chroma .kr {

    --tw-text-opacity: 1;

    color: rgb(96 165 250 / var(--tw-text-opacity))
}

/* KeywordType */

.chroma .kt {

    --tw-text-opacity: 1;

    color: rgb(192 132 252 / var(--tw-text-opacity))
}

/* Name */

.chroma .n {}

/* NameAttribute */

.chroma .na {

    --tw-text-opacity: 1;

    color: rgb(250 204 21 / var(--tw-text-opacity))
}

/* NameBuiltin */

.chroma .nb {

    --tw-text-opacity: 1;

    color: rgb(251 146 60 / var(--tw-text-opacity))
}

/* NameBuiltinPseudo */

.chroma .bp {}

/* NameClass */

.chroma .nc {

    --tw-text-opacity: 1;

    color: rgb(248 113 113 / var(--tw-text-opacity))
}

/* NameConstant */

.chroma .no {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* NameDecorator */

.chroma .nd {

    --tw-text-opacity: 1;

    color: rgb(248 113 113 / var(--tw-text-opacity))
}

/* NameEntity */

.chroma .ni {}

/* NameException */

.chroma .ne {

    --tw-text-opacity: 1;

    color: rgb(248 113 113 / var(--tw-text-opacity))
}

/* NameFunction */

.chroma .nf {

    --tw-text-opacity: 1;

    color: rgb(251 146 60 / var(--tw-text-opacity))
}

/* NameFunctionMagic */

.chroma .fm {}

/* NameLabel */

.chroma .nl {}

/* NameNamespace */

.chroma .nn {}

/* NameOther */

.chroma .nx {}

/* NameProperty */

.chroma .py {}

/* NameTag */

.chroma .nt {

    --tw-text-opacity: 1;

    color: rgb(248 113 113 / var(--tw-text-opacity))
}

/* NameVariable */

.chroma .nv {}

/* NameVariableClass */

.chroma .vc {}

/* NameVariableGlobal */

.chroma .vg {}

/* NameVariableInstance */

.chroma .vi {}

/* NameVariableMagic */

.chroma .vm {}

/* Literal */

.chroma .l {

    --tw-text-opacity: 1;

    color: rgb(192 132 252 / var(--tw-text-opacity))
}

/* LiteralDate */

.chroma .ld {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralString */

.chroma .s {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringAffix */

.chroma .sa {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringBacktick */

.chroma .sb {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringChar */

.chroma .sc {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringDelimiter */

.chroma .dl {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringDoc */

.chroma .sd {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringDouble */

.chroma .s2 {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringEscape */

.chroma .se {

    --tw-text-opacity: 1;

    color: rgb(107 114 128 / var(--tw-text-opacity))
}

/* LiteralStringHeredoc */

.chroma .sh {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringInterpol */

.chroma .si {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringOther */

.chroma .sx {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringRegex */

.chroma .sr {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringSingle */

.chroma .s1 {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralStringSymbol */

.chroma .ss {

    --tw-text-opacity: 1;

    color: rgb(74 222 128 / var(--tw-text-opacity))
}

/* LiteralNumber */

.chroma .m {

    --tw-text-opacity: 1;

    color: rgb(192 132 252 / var(--tw-text-opacity))
}

/* LiteralNumberBin */

.chroma .mb {

    --tw-text-opacity: 1;

    color: rgb(192 132 252 / var(--tw-text-opacity))
}

/* LiteralNumberFloat */

.chroma .mf {

    --tw-text-opacity: 1;

    color: rgb(192 132 252 / var(--tw-text-opacity))
}

/* LiteralNumberHex */

.chroma .mh {

    --tw-text-opacity: 1;

    color: rgb(192 132 252 / var(--tw-text-opacity))
}

/* LiteralNumberInteger */

.chroma .mi {

    --tw-text-opacity: 1;

    color: rgb(192 132 252 / var(--tw-text-opacity))
}

/* LiteralNumberIntegerLong */

.chroma .il {

    --tw-text-opacity: 1;

    color: rgb(192 132 252 / var(--tw-text-opacity))
}

/* LiteralNumberOct */

.chroma .mo {

    --tw-text-opacity: 1;

    color: rgb(192 132 252 / var(--tw-text-opacity))
}

/* Operator */

.chroma .o {

    --tw-text-opacity: 1;

    color: rgb(147 197 253 / var(--tw-text-opacity))
}

/* OperatorWord */

.chroma .ow {

    --tw-text-opacity: 1;

    color: rgb(147 197 253 / var(--tw-text-opacity))
}

/* Punctuation */

.chroma .p {

    --tw-text-opacity: 1;

    color: rgb(156 163 175 / var(--tw-text-opacity))
}

/* Comment */

.chroma .c {

    --tw-text-opacity: 1;

    color: rgb(107 114 128 / var(--tw-text-opacity))
}

/* CommentHashbang */

.chroma .ch {

    --tw-text-opacity: 1;

    color: rgb(107 114 128 / var(--tw-text-opacity))
}

/* CommentMultiline */

.chroma .cm {

    --tw-text-opacity: 1;

    color: rgb(107 114 128 / var(--tw-text-opacity))
}

/* CommentSingle */

.chroma .c1 {

    --tw-text-opacity: 1;

    color: rgb(107 114 128 / var(--tw-text-opacity))
}

/* CommentSpecial */

.chroma .cs {

    --tw-text-opacity: 1;

    color: rgb(107 114 128 / var(--tw-text-opacity))
}

/* CommentPreproc */

.chroma .cp {

    --tw-text-opacity: 1;

    color: rgb(107 114 128 / var(--tw-text-opacity))
}

/* CommentPreprocFile */

.chroma .cpf {

    --tw-text-opacity: 1;

    color: rgb(107 114 128 / var(--tw-text-opacity))
}

/* Generic */

.chroma .g {}

/* GenericDeleted */

.chroma .gd {}

/* GenericEmph */

.chroma .ge {

    font-style: italic
}

/* GenericError */

.chroma .gr {}

/* GenericHeading */

.chroma .gh {}

/* GenericInserted */

.chroma .gi {}

/* GenericOutput */

.chroma .go {}

/* GenericPrompt */

.chroma .gp {}

/* GenericStrong */

.chroma .gs {

    font-weight: 700
}

/* GenericSubheading */

.chroma .gu {}

/* GenericTraceback */

.chroma .gt {}

/* GenericUnderline */

.chroma .gl {}

/* TextWhitespace */

.chroma .w {}
</style>

<link rel="preload" as="image" href="https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/vignette-example-1.jpg">

<title>Fixing Screenspace Effects For VR : julhe.github.io</title>

<meta property="og:title" content="Fixing Screenspace Effects For VR">
<meta property="og:site_name" content="julhe.github.io">
<meta property="og:url" content="https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/">
<link rel="image_src" href="https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/vignette-example-1.jpg">
<meta property="og:image" content="https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/vignette-example-1.jpg">
<meta property="og:image:width" content="">
<meta property="og:image:height" content="">
<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:description" content="Making vignetting work in VR to prevent motion sickness.">
<meta name="description" content="Making vignetting work in VR to prevent motion sickness.">
<meta property="og:updated_time" content="2017-12-21T19:24:00Z">
<meta property="fb:app_id" content="">
<meta name="author" content="Unknown">
<meta property="article:author" content="https://julhe.github.io/">
<meta property="article:published_time" content="2017-12-21T19:24:00Z">
<meta property="article:modified_time" content="2017-12-21T19:24:00Z">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Fixing Screenspace Effects For VR",
  "alternativeHeadline": "Making vignetting work in VR to prevent motion sickness.",
  "url": "https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/",
  "image": "https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/vignette-example-1.jpg",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/"
  },
  "description": "Making vignetting work in VR to prevent motion sickness.",
  "author": {
    "@type": "Person",
    "name": "Unknown"
  },
  "publisher": {
    "@type": "Organization",
    "name": "julhe.github.io",
    "logo": {
      "@type": "ImageObject",
      "url": "https://julhe.github.io/"
    }
  },
  "datePublished": "2017-12-21T19:24:00Z",
  "dateModified": "2017-12-21T19:24:00Z",
  "articleBody": "\u003cp\u003eIn virtual reality, vignetting is a handy tool to fight motion sickness, games like Eagle Flight do this and also our beloved Lucid Trips!\u003c/p\u003e\n\r\n\r\n\u003cfigure\u003e\r\n\u003cimg\r\nclass=\"mb-2 mx-auto leading-none shadow-xl\"\r\nsrc=\"/posts/fixing_screenspace_effects_for_vr/vignette-example-1.jpg\"\r\nalt=\"Lucid Trips with vignetting\"\u003e\r\n\u003cfigcaption class=\"text-sm text-right text-raven-500\"\u003e\r\n\u003cp\u003eLucid Trips with vignetting\u003c/p\u003e\r\n\u003c/figcaption\u003e\r\n\u003c/figure\u003e\r\n\n\u003cp\u003eBut the \u0026ldquo;stock\u0026rdquo; vignette that we copy from traditional games is actually not made for in-your-face-screens.  This might not be obvious in the first place, but once you see the raw vignette, it makes your eyes literally hurt.\u003c/p\u003e\n\u003cp\u003eThe reason is simple: the screen center, which is also center of the vignette, is not the eye center. Every Head-Mounted-Display is different here where this position exactly is:\u003c/p\u003e\n\r\n\r\n\u003cfigure\u003e\r\n\u003cimg\r\nclass=\"mb-2 mx-auto leading-none shadow-xl\"\r\nsrc=\"/posts/fixing_screenspace_effects_for_vr/vrEyeSpace-3-768x272.png\"\r\nalt=\"Screen-Center vs. Eye-Center\"\u003e\r\n\u003cfigcaption class=\"text-sm text-right text-raven-500\"\u003e\r\n\u003cp\u003eScreen-Center vs. Eye-Center\u003c/p\u003e\r\n\u003c/figcaption\u003e\r\n\u003c/figure\u003e\r\n\n\u003cp\u003eBut one can figure out the actually eye center position.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ePlace a point in front of the camera. From my tests, it should not be too close. 10 units seems to be alright.\u003c/li\u003e\n\u003cli\u003eThen obtain the screen coordinate of this point for each eye and pass it to the shader.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThis works for both Single- and Multi-Pass rendering (which was the original motivation to do this).\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eLet\u0026rsquo;s Code!\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eUnity offers \u003ccode\u003ecurrentCamera.transform.forward\u003c/code\u003e to get our cameras looking direction. Now we need to multiply the direction by our desired distance and add the world-position of our camera to it, done.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-csharp\" data-lang=\"csharp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eVector3 currentCameraForward = transform.forward; \u003cspan style=\"color:#6272a4\"\u003e//translate vignetting direction to world space position \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eVector3 vignetteCenterWorldSpace = transform.position + vignetteWorldSpaceDirection * VIGNETTING_DEPTH;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003eOur point is a world-space coordinate, but our vignette is calculated in viewport-space\u0026hellip; First, we need theses helper functions:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-csharp\" data-lang=\"csharp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eMatrix4x4 GetStereoWorldToViewMatrix(Camera.StereoscopicEye eye) { \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#ff79c6\"\u003ereturn\u003c/span\u003e currentCamera.GetStereoProjectionMatrix(eye) * currentCamera.GetStereoViewMatrix(eye); \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#8be9fd;font-style:italic\"\u003estatic\u003c/span\u003e Vector4 NormalizeScreenSpaceCords(Vector4 coords) { \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#6272a4\"\u003e//normalize viewport coords from [-1, 1] [0, 1] \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#ff79c6\"\u003ereturn\u003c/span\u003e (coords * \u003cspan style=\"color:#bd93f9\"\u003e0.5f\u003c/span\u003e) + Vector4.one * \u003cspan style=\"color:#bd93f9\"\u003e0.5f\u003c/span\u003e; \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we calculate the viewport positions:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-csharp\" data-lang=\"csharp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eMatrix4x4 worldToClipSpace_left = GetWorldToClipMatrix(Camera.StereoscopicEye.Left);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eviewportSpaceOffset[\u003cspan style=\"color:#bd93f9\"\u003e0\u003c/span\u003e] =  worldToClipSpace_left.MultiplyPoint(vignetteCenterWorldSpace);\u003cspan style=\"color:#6272a4\"\u003e// get world-space position as clip-space position \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eviewportSpaceOffset[\u003cspan style=\"color:#bd93f9\"\u003e0\u003c/span\u003e] = -NormalizeScreenSpaceCords(viewportSpaceOffset[\u003cspan style=\"color:#bd93f9\"\u003e0\u003c/span\u003e]);\u003cspan style=\"color:#6272a4\"\u003e// convert clip-space [-1,1] to viewport space [0,1]. also negate the offset.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#6272a4\"\u003e// the same for the right eye...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eLet’s recall the pipeline which leads us to the viewport position: world-space ⇨ view-space ⇨ clip-space ⇨ viewport-space. I don’t want to get too deep into the topic here, but if your interested, I will link some resources down below.\n3. Now we are ready for the shader! Assuming our vertex shader just passes in the pure screenspace uv coordinates, we first set up our pixel-shader.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-csharp\" data-lang=\"csharp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003efloat2 screenUV = UnityStereoScreenSpaceUVAdjust(i.uv, _MainTex_ST);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ff79c6\"\u003e#if\u003c/span\u003e (UNITY_SINGLE_PASS_STEREO)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#6272a4\"\u003e// in single pass, we need to figure out what eye we\u0026#39;re rendering to by our selfs\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  unity_StereoEyeIndex = screenUV \u0026gt; \u003cspan style=\"color:#bd93f9\"\u003e0.5\u003c/span\u003e;\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ff79c6\"\u003e#endif\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ehalf2 vignetteCenter = i.uv;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eA vignette is basically a circle… …but smooth… we can calculate a by taking the distance to our fresh calculated eye center.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-csharp\" data-lang=\"csharp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003evignetteCenter += _vignetteViewportSpaceOffset[unity_StereoEyeIndex].xy; \u003cspan style=\"color:#6272a4\"\u003e// shift to center\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003evignetteCenter *= \u003cspan style=\"color:#bd93f9\"\u003e2.0\u003c/span\u003e; \u003cspan style=\"color:#6272a4\"\u003e// make vignette a bit tighter\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ehalf mask = dot(vignetteCenter, vignetteCenter); \u003cspan style=\"color:#6272a4\"\u003e// compute square length from center\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we just need to combine it with the input…\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-csharp\" data-lang=\"csharp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ehalf4 col = tex2D(_MainTex, screenUV);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ff79c6\"\u003ereturn\u003c/span\u003e col * mask; \u003cspan style=\"color:#6272a4\"\u003e//compose\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd that’s it. Look into the Unity package for the full implementation.\u003c/p\u003e\n\u003cp\u003eSome resources:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://youtu.be/cvcAjgMUPUA\"\u003eTheHappyCat - How Rendering Graphics Works in Games!\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://stackoverflow.com/questions/15588860/what-exactly-are-eye-space-coordinates#15592361\"\u003eWhat exactly are eye space coordinates? (StackOverflow)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.unity3d.com/ScriptReference/Camera.WorldToViewportPoint.html\"\u003eUnitys WorldToViewportPoint()\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"
}
</script>

<link rel="preload" as="script" href="https://julhe.github.io/bundle.js?v=1711549188">


</head>
<body>

  <header id="nav" class="header">
  <div class="ax-l-i max-w-6xl">
    <div class="ax-logo">
      <a class="block" href="https://julhe.github.io/" title="julhe.github.io"><span class="font-semibold text-raven-900">julhe.github.io</span></a>
    </div>
    <div class="ax-user">
      <a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target="_blank" rel="noopener nofollow" href="https://www.google.com/search?q=site:https%3a%2f%2fjulhe.github.io%2f" title="Search">
        <svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923l-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33 0 0 0 2.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg>

      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="https://julhe.github.io/about">
        About
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="https://julhe.github.io/posts">
        Posts
      </a>
    </div>
  </div>

  
</header>

  <main>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<div class="default-single">
  <div class="ax-title ax-l-o">
    <div class="ax-l-i max-w-680">
      <h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">Fixing Screenspace Effects For VR</h1>

      <div class="ax-meta flex items-center mt-5">
        <div class="flex-grow min-w-0">
          <div class="flex items-center">
  <div class="flex-shrink-0">
    
  </div>
  <div class="flex-shrink-0 ml-2 leading-tight font-content-sans">
    <a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target="_blank" rel="noopener nofollow" title="Unknown" href="https://julhe.github.io/">Unknown</a>
    <time class="text-sm text-raven-500" datetime="2017-12-21T19:24:00Z">Dec 21, 2017 8:24PM</time>
  </div>
</div>

        </div>
        <div>
          <div class="flex items-center">
  <a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=Fixing%20Screenspace%20Effects%20For%20VR%20by%20%40%23%20https%3a%2f%2fjulhe.github.io%2fposts%2ffixing_screenspace_effects_for_vr%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg>
</a>
  <a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2fjulhe.github.io%2fposts%2ffixing_screenspace_effects_for_vr%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234 0H1.765C.8.001 0 .79 0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766 0 3.284.13 3.726.2v4.32h-2.543c-2.006 0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21 0 30.234 0z"/></svg>
</a>
</div>

        </div>
      </div>
    </div>
  </div>
  <div class="ax-feature ax-l-o">
    <div class="ax-l-i max-w-5xl">

<figure>
<img
class="mb-2 mx-auto leading-none shadow-xl"
src="https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/vignette-example-1.jpg"
alt="Fixing Screenspace Effects For VR">
</figure>

    </div>
  </div><div class="ax-content ax-l-o">
    <div class="ax-l-i max-w-680">
      <article class="cdata">
<p>In virtual reality, vignetting is a handy tool to fight motion sickness, games like Eagle Flight do this and also our beloved Lucid Trips!</p>


<figure>
<img
class="mb-2 mx-auto leading-none shadow-xl"
src="https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/vignette-example-1.jpg"
alt="Lucid Trips with vignetting">
<figcaption class="text-sm text-right text-raven-500">
<p>Lucid Trips with vignetting</p>
</figcaption>
</figure>

<p>But the &ldquo;stock&rdquo; vignette that we copy from traditional games is actually not made for in-your-face-screens.  This might not be obvious in the first place, but once you see the raw vignette, it makes your eyes literally hurt.</p>
<p>The reason is simple: the screen center, which is also center of the vignette, is not the eye center. Every Head-Mounted-Display is different here where this position exactly is:</p>


<figure>
<img
class="mb-2 mx-auto leading-none shadow-xl"
src="https://julhe.github.io/posts/fixing_screenspace_effects_for_vr/vrEyeSpace-3-768x272.png"
alt="Screen-Center vs. Eye-Center">
<figcaption class="text-sm text-right text-raven-500">
<p>Screen-Center vs. Eye-Center</p>
</figcaption>
</figure>

<p>But one can figure out the actually eye center position.</p>
<ol>
<li>Place a point in front of the camera. From my tests, it should not be too close. 10 units seems to be alright.</li>
<li>Then obtain the screen coordinate of this point for each eye and pass it to the shader.</li>
</ol>
<p>This works for both Single- and Multi-Pass rendering (which was the original motivation to do this).</p>
<hr>
<p>Let&rsquo;s Code!</p>
<ol>
<li>Unity offers <code>currentCamera.transform.forward</code> to get our cameras looking direction. Now we need to multiply the direction by our desired distance and add the world-position of our camera to it, done.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Vector3 currentCameraForward = transform.forward; <span style="color:#6272a4">//translate vignetting direction to world space position </span>
</span></span><span style="display:flex;"><span>Vector3 vignetteCenterWorldSpace = transform.position + vignetteWorldSpaceDirection * VIGNETTING_DEPTH;
</span></span></code></pre></div><ol start="2">
<li>Our point is a world-space coordinate, but our vignette is calculated in viewport-space&hellip; First, we need theses helper functions:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Matrix4x4 GetStereoWorldToViewMatrix(Camera.StereoscopicEye eye) { 
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> currentCamera.GetStereoProjectionMatrix(eye) * currentCamera.GetStereoViewMatrix(eye); 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">static</span> Vector4 NormalizeScreenSpaceCords(Vector4 coords) { 
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//normalize viewport coords from [-1, 1] [0, 1] </span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> (coords * <span style="color:#bd93f9">0.5f</span>) + Vector4.one * <span style="color:#bd93f9">0.5f</span>; 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now we calculate the viewport positions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Matrix4x4 worldToClipSpace_left = GetWorldToClipMatrix(Camera.StereoscopicEye.Left);
</span></span><span style="display:flex;"><span>viewportSpaceOffset[<span style="color:#bd93f9">0</span>] =  worldToClipSpace_left.MultiplyPoint(vignetteCenterWorldSpace);<span style="color:#6272a4">// get world-space position as clip-space position </span>
</span></span><span style="display:flex;"><span>viewportSpaceOffset[<span style="color:#bd93f9">0</span>] = -NormalizeScreenSpaceCords(viewportSpaceOffset[<span style="color:#bd93f9">0</span>]);<span style="color:#6272a4">// convert clip-space [-1,1] to viewport space [0,1]. also negate the offset.</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// the same for the right eye...</span>
</span></span></code></pre></div><p>Let’s recall the pipeline which leads us to the viewport position: world-space ⇨ view-space ⇨ clip-space ⇨ viewport-space. I don’t want to get too deep into the topic here, but if your interested, I will link some resources down below.
3. Now we are ready for the shader! Assuming our vertex shader just passes in the pure screenspace uv coordinates, we first set up our pixel-shader.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>float2 screenUV = UnityStereoScreenSpaceUVAdjust(i.uv, _MainTex_ST);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#if</span> (UNITY_SINGLE_PASS_STEREO)
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// in single pass, we need to figure out what eye we&#39;re rendering to by our selfs</span>
</span></span><span style="display:flex;"><span>  unity_StereoEyeIndex = screenUV &gt; <span style="color:#bd93f9">0.5</span>;		
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#endif</span>
</span></span><span style="display:flex;"><span>half2 vignetteCenter = i.uv;
</span></span></code></pre></div><p>A vignette is basically a circle… …but smooth… we can calculate a by taking the distance to our fresh calculated eye center.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>vignetteCenter += _vignetteViewportSpaceOffset[unity_StereoEyeIndex].xy; <span style="color:#6272a4">// shift to center</span>
</span></span><span style="display:flex;"><span>vignetteCenter *= <span style="color:#bd93f9">2.0</span>; <span style="color:#6272a4">// make vignette a bit tighter</span>
</span></span><span style="display:flex;"><span>half mask = dot(vignetteCenter, vignetteCenter); <span style="color:#6272a4">// compute square length from center</span>
</span></span></code></pre></div><p>Now we just need to combine it with the input…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>half4 col = tex2D(_MainTex, screenUV);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> col * mask; <span style="color:#6272a4">//compose</span>
</span></span></code></pre></div><p>And that’s it. Look into the Unity package for the full implementation.</p>
<p>Some resources:</p>
<ul>
<li><a href="https://youtu.be/cvcAjgMUPUA">TheHappyCat - How Rendering Graphics Works in Games!</a></li>
<li><a href="https://stackoverflow.com/questions/15588860/what-exactly-are-eye-space-coordinates#15592361">What exactly are eye space coordinates? (StackOverflow)</a></li>
<li><a href="https://docs.unity3d.com/ScriptReference/Camera.WorldToViewportPoint.html">Unitys WorldToViewportPoint()</a></li>
</ul>

      </article>
      

      

    </div>
  </div>
</div>
<hr>
<script src="https://utteranc.es/client.js"
        repo="julhe/julhe.github.io"
        issue-term="pathname"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

  </main>
  <footer class="footer">
  <div class="ax-l-i max-w-6xl">
    <nav class="flex items-center justify-center">
    </nav>
    <div class="footer-social flex items-center justify-center mt-4">
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Twitter" href="https://twitter.com/schneckerstein"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Github" href="https://github.com/julhe"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998 0C7.164 0 0 7.35 0 16.417 0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113 0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344 0 0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98 0 0 1 4.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406 0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836 0 15.998 0z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="LinkedIn" href="https://www.linkedin.com/in/julian-heinken-34463327/"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M29.692 0H2.308A2.31 2.31 0 0 0 0 2.308v27.384A2.31 2.31 0 0 0 2.308 32h27.384A2.31 2.31 0 0 0 32 29.692V2.308A2.31 2.31 0 0 0 29.692 0zM11.35 24.188H7.454V12.464h3.897v11.723zM9.402 10.863h-.025c-1.308 0-2.153-.9-2.153-2.025 0-1.15.872-2.026 2.205-2.026s2.153.875 2.18 2.026c0 1.125-.846 2.025-2.205 2.025zm16 13.324h-3.896v-6.272c0-1.576-.564-2.65-1.974-2.65-1.076 0-1.717.725-2 1.425-.103.25-.128.6-.128.95v6.547h-3.896V12.464h3.896v1.66c.518-.8 1.444-1.935 3.512-1.935 2.564 0 4.486 1.676 4.486 5.276v6.722z"/></svg></a>
    </div>

    <div class="footer-copyright text-sm text-center text-gray-500 mt-4">
      &#169; -2024 Julian Heinken
    </div>
    <div class="text-sm sm:text-xs text-center text-gray-500 mt-2">
      Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a>
    </div>
  </div>
</footer>

<script src="https://julhe.github.io/bundle.js?v=1711549188"></script>


</body>
</html>
